#!/bin/bash
set -eu
source /var/vcap/jobs/shield/helpers/utils database
export LANG=en_US.UTF-8

case $1 in
  start)
    pid_guard $PIDFILE database

    <% if p('database') == 'postgres' %>
    export PATH=$PATH:/var/vcap/packages/postgres/bin
    export PGDATA=$STORE_DIR/postgres
    test -d $PGDATA || chpst -u vcap:vcap initdb -E utf8 --locale en_US.UTF-8

    echo $$ > $PIDFILE
    exec chpst -u vcap:vcap postgres

    <% elsif p('database') == 'mysql' %>
    export PATH=$PATH:/var/vcap/packages/mariadb/bin
    export MYSQL_HOME=/var/vcap/jobs/shield/config/mariadb
    DATADIR=/var/vcap/store/shield/mariadb
    mkdir -p $DATADIR

    if [[ ! -d $DATADIR/mysql ]]; then
      (cd /var/vcap/packages/mariadb && ./scripts/mysql_install_db)
      chown -R vcap:vcap $DATADIR
    fi

    echo $$ > $PIDFILE
    exec chpst -u vcap:vcap mysqld

    <% else raise "Invalid database type '#{p('database')}' specified (must be one of either 'mysql' or 'postgres')" %>
    <% end %>
    ;;

  stop)
    kill_and_wait $PIDFILE
    ;;

  *)
    echo "Usage: database {start|stop}"
    ;;

esac
exit 0
